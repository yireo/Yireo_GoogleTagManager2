<?php

declare(strict_types=1);

use Magento\Framework\View\Element\Template;
use Tagging\GTM\Config\Config;

/** @var Config $config */
/** @var Template $block */
$config = $block->getConfig();

// Get SecureHtmlRenderer using Object Manager for compatibility
$objectManager = \Magento\Framework\App\ObjectManager::getInstance();
$secureRenderer = $objectManager->get(\Magento\Framework\View\Helper\SecureHtmlRenderer::class);

// Detect if we're in Hyv√§ context
$isHyva = isset($hyvaCsp) && $hyvaCsp;

// Build the script content
$scriptContent = <<<SCRIPT
window.Tagging_GTM_ENABLED = true;
SCRIPT;

if ($config->isEnabled()) {
    $scriptContent .= "\nwindow.Tagging_ENABLED_PLUGIN = true;";
} else {
    $scriptContent .= "\nwindow.Tagging_ENABLED_PLUGIN = false;";
}

if ($config->isPlacedByPlugin()) {
    $scriptContent .= "\nwindow.Tagging_PLACED_BY_PLUGIN = true;";
} else {
    $scriptContent .= "\nwindow.Tagging_PLACED_BY_PLUGIN = false;";
}

$scriptContent .= "\nwindow.Tagging_PLUGIN_VERSION = '{$config->getVersion()}';";

$scriptContent .= <<<SCRIPT

(function(events) {
    const initgoogleTagManager2 = function() {
        events.forEach(function(eventType) {
            window.removeEventListener(eventType, initgoogleTagManager2);
        });
SCRIPT;

if ($config->isEnabled() && $config->isPlacedByPlugin()) {
    $scriptContent .= "\n" . $config->getConfig();
}

$scriptContent .= <<<SCRIPT

    }

    events.forEach(function(eventType) {
        window.addEventListener(eventType, initgoogleTagManager2, {
            once: true,
            passive: true
        })
    })
})(['load']);
SCRIPT;

// Render the main script based on context
if ($isHyva): ?>
    <script>
        <?= $scriptContent ?>
    </script><?php $hyvaCsp->registerInlineScript() ?>
<?php else:
    echo $secureRenderer->renderTag('script', ['type' => 'text/javascript'], $scriptContent, false);
endif; ?>

<?php if ($config->isDebug()) : ?>
    <?php
    $debugScript = "window.Tagging_GTM_DEBUG = true;";
    if ($isHyva): ?>
        <script>
            <?= $debugScript ?>
        </script><?php $hyvaCsp->registerInlineScript() ?>
    <?php else:
        echo $secureRenderer->renderTag('script', ['type' => 'text/javascript'], $debugScript, false);
    endif; ?>
<?php endif; ?>